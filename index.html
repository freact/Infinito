<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinito - Strategy Board Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .grid-board {
            display: grid;
            grid-template-columns: repeat(8, minmax(0, 1fr));
            gap: 2px;
            background-color: #4b5563; /* Gray 600 */
            border: 4px solid #1f2937; /* Gray 800 */
        }
        .cell {
            aspect-ratio: 1 / 1;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .cell:hover { background-color: #f3f4f6; }
        .cell.valid-move::after {
            content: '';
            width: 12px;
            height: 12px;
            background-color: #10b981;
            border-radius: 50%;
            opacity: 0.4;
        }
        .cell.selected { background-color: #fef08a; } /* Yellow 200 */
        
        .stone {
            width: 85%;
            height: 85%;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid #374151;
            z-index: 10;
        }
        .stone-black { background-color: #111827; color: #f9fafb; }
        .stone-white { background-color: #f9fafb; color: #111827; }
        .stone-neutral { 
            background-color: #9ca3af; 
            color: #f3f4f6; 
            border-style: dashed; 
            border-color: #4b5563;
        }
        .removable-highlight {
            animation: pulse 1.5s infinite;
            border: 3px solid #ef4444 !important;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">INFINITO</h1>
            <p class="text-gray-600 font-medium">Strategic placement. Move to remove your high values.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8 items-start justify-center">
            <!-- Game Board -->
            <div class="w-full max-w-md bg-white p-2 rounded-xl shadow-2xl">
                <div id="board" class="grid-board rounded-lg overflow-hidden">
                    <!-- Cells generated by JS -->
                </div>
            </div>

            <!-- UI Panel -->
            <div class="w-full lg:w-96 space-y-4">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-8 border-indigo-600">
                    <h2 class="text-xs uppercase tracking-widest text-gray-400 font-bold mb-1">Turn Control</h2>
                    <div id="turn-indicator" class="flex items-center gap-3 mb-6">
                        <div id="turn-color-pill" class="w-8 h-8 rounded-full border-2 border-gray-200 shadow-sm"></div>
                        <span id="turn-name" class="font-black text-2xl uppercase italic">Black</span>
                    </div>
                    
                    <div id="phase-container" class="bg-indigo-50 p-4 rounded-lg mb-4 transition-all">
                        <p class="text-[10px] text-indigo-800 font-black uppercase tracking-widest mb-1">Current Action</p>
                        <p id="phase-text" class="text-xl font-bold text-indigo-900 leading-tight">Optional Move</p>
                    </div>

                    <div id="removal-bonus" class="hidden bg-emerald-100 p-4 rounded-lg mb-4 border-2 border-emerald-500 animate-bounce">
                        <p class="text-emerald-800 text-sm font-black italic underline">STRATEGIC REMOVAL!</p>
                        <p class="text-emerald-700 text-xs mt-1">Select <span id="removal-count" class="font-bold text-lg">0</span> stone(s) to turn into ∞ and lower your score.</p>
                    </div>

                    <div id="placement-ui" class="hidden space-y-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <label class="block text-sm font-bold text-gray-700">Choose value (k):</label>
                        <div class="flex gap-2">
                            <input type="number" id="place-value" min="0" 
                                class="w-full p-3 text-xl font-bold border-2 border-indigo-300 rounded-lg focus:ring-4 focus:ring-indigo-200 outline-none transition-all" 
                                placeholder="0">
                        </div>
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Cannot be a number currently on the board.</p>
                    </div>

                    <div class="flex flex-col gap-2 mt-6">
                        <button id="skip-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-black py-3 px-4 rounded-lg shadow-md transition-all active:scale-95">
                            SKIP MOVE PHASE
                        </button>
                    </div>
                </div>

                <!-- Scores and Used Numbers -->
                <div class="grid grid-cols-2 lg:grid-cols-1 gap-4">
                    <div class="bg-gray-900 text-white p-5 rounded-xl shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-2 opacity-10">
                            <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20"><path d="M13 7H7v6h6V7z"></path><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-1 0a7 7 0 11-14 0 7 7 0 0114 0z" clip-rule="evenodd"></path></svg>
                        </div>
                        <p class="text-[10px] uppercase font-black tracking-widest opacity-60">Black Total</p>
                        <p id="black-score" class="text-4xl font-mono font-black">0</p>
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <p class="text-[10px] uppercase font-bold opacity-40">Active Stones</p>
                            <p id="black-used" class="text-xs font-mono opacity-80 mt-1"></p>
                        </div>
                    </div>
                    <div class="bg-white text-gray-900 p-5 rounded-xl shadow-lg border border-gray-200 relative overflow-hidden">
                        <p class="text-[10px] uppercase font-black tracking-widest text-gray-400">White Total</p>
                        <p id="white-score" class="text-4xl font-mono font-black">0</p>
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <p class="text-[10px] uppercase font-bold text-gray-300">Active Stones</p>
                            <p id="white-used" class="text-xs font-mono text-gray-500 mt-1"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SIZE = 8;
        let board = Array(SIZE).fill(null).map(() => Array(SIZE).fill(null));
        let currentPlayer = 'black';
        let phase = 'MOVE'; // 'MOVE' | 'REMOVAL_BONUS' | 'PLACE'
        let selectedCell = null;
        let removalsToResolve = 0;
        let movedStoneCoords = null;
        
        let activeValues = {
            black: new Set(),
            white: new Set()
        };

        const boardEl = document.getElementById('board');
        const phaseEl = document.getElementById('phase-text');
        const turnNameEl = document.getElementById('turn-name');
        const turnPillEl = document.getElementById('turn-color-pill');
        const skipBtn = document.getElementById('skip-btn');
        const placementUI = document.getElementById('placement-ui');
        const valInput = document.getElementById('place-value');
        const removalBonusUI = document.getElementById('removal-bonus');
        const removalCountEl = document.getElementById('removal-count');

        function init() {
            createGrid();
            checkAndAutoSkipMove();
            updateUI();
        }

        function createGrid() {
            boardEl.innerHTML = '';
            for (let r = 0; r < SIZE; r++) {
                for (let c = 0; c < SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    cell.addEventListener('click', () => handleCellClick(r, c));
                    boardEl.appendChild(cell);
                }
            }
        }

        function handleCellClick(r, c) {
            const stone = board[r][c];

            if (phase === 'MOVE') {
                if (selectedCell) {
                    if (r === selectedCell.r && c === selectedCell.c) {
                        selectedCell = null;
                    } else if (!stone && isValidQueenMove(selectedCell.r, selectedCell.c, r, c)) {
                        executeMove(selectedCell.r, selectedCell.c, r, c);
                    } else {
                        selectedCell = null;
                    }
                } else if (stone && stone.owner === currentPlayer) {
                    selectedCell = { r, c };
                }
            } else if (phase === 'REMOVAL_BONUS') {
                if (stone && stone.owner === currentPlayer && (r !== movedStoneCoords.r || c !== movedStoneCoords.c)) {
                    activeValues[currentPlayer].delete(stone.val);
                    board[r][c] = { owner: 'neutral', val: '∞' };
                    removalsToResolve--;
                    if (removalsToResolve <= 0) enterPlacementPhase();
                }
            } else if (phase === 'PLACE') {
                if (!stone) {
                    const val = parseInt(valInput.value);
                    if (isNaN(val) || val < 0) return;
                    if (activeValues[currentPlayer].has(val)) {
                        alert(`You are already using the value ${val} on the board!`);
                        return;
                    }
                    
                    board[r][c] = { owner: currentPlayer, val: val };
                    activeValues[currentPlayer].add(val);
                    endTurn();
                }
            }
            updateUI();
        }

        function isValidQueenMove(r1, c1, r2, c2) {
            const dr = Math.abs(r1 - r2);
            const dc = Math.abs(c1 - c2);
            if (dr !== 0 && dc !== 0 && dr !== dc) return false;
            
            const stepR = r1 === r2 ? 0 : (r2 > r1 ? 1 : -1);
            const stepC = c1 === c2 ? 0 : (c2 > c1 ? 1 : -1);
            
            let currR = r1 + stepR;
            let currC = c1 + stepC;
            while (currR !== r2 || currC !== c2) {
                if (board[currR][currC]) return false;
                currR += stepR;
                currC += stepC;
            }
            return true;
        }

        function executeMove(r1, c1, r2, c2) {
            const stone = board[r1][c1];
            board[r1][c1] = null;
            board[r2][c2] = stone;
            
            let removalRewards = 0;
            const enemy = currentPlayer === 'black' ? 'white' : 'black';
            
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    if (dr === 0 && dc === 0) continue;
                    const nr = r2 + dr, nc = c2 + dc;
                    if (nr >= 0 && nr < SIZE && nc >= 0 && nc < SIZE) {
                        const target = board[nr][nc];
                        if (target && target.owner === enemy && target.val < stone.val) {
                            removalRewards++;
                        }
                    }
                }
            }

            if (removalRewards > 0 && activeValues[currentPlayer].size > 1) {
                removalsToResolve = removalRewards;
                movedStoneCoords = { r: r2, c: c2 };
                phase = 'REMOVAL_BONUS';
            } else {
                enterPlacementPhase();
            }
            selectedCell = null;
        }

        function enterPlacementPhase() {
            phase = 'PLACE';
            let suggestion = 0;
            while(activeValues[currentPlayer].has(suggestion)) suggestion++;
            valInput.value = suggestion;
            
            // Focus and select input automatically
            setTimeout(() => {
                valInput.focus();
                valInput.select();
            }, 10);
        }

        function endTurn() {
            currentPlayer = currentPlayer === 'black' ? 'white' : 'black';
            phase = 'MOVE';
            removalsToResolve = 0;
            movedStoneCoords = null;
            
            if (board.flat().every(cell => cell !== null)) {
                const bS = calculateScore('black');
                const wS = calculateScore('white');
                const winner = bS < wS ? 'Black wins!' : (wS < bS ? 'White wins!' : 'Draw!');
                alert(`Game Over! \nFinal Score - Black: ${bS} | White: ${wS}\n\n${winner}`);
                return;
            }

            // Check if next player has any stones to move
            checkAndAutoSkipMove();
        }

        /**
         * Checks if the current player has any stones on the board.
         * If not, automatically moves to the placement phase.
         */
        function checkAndAutoSkipMove() {
            if (phase === 'MOVE' && activeValues[currentPlayer].size === 0) {
                enterPlacementPhase();
            }
        }

        function calculateScore(player) {
            let sum = 0;
            board.forEach(row => row.forEach(cell => {
                if (cell && cell.owner === player) sum += cell.val;
            }));
            return sum;
        }

        function updateUI() {
            const cells = boardEl.querySelectorAll('.cell');
            cells.forEach(cell => {
                const r = parseInt(cell.dataset.r);
                const c = parseInt(cell.dataset.c);
                const data = board[r][c];
                
                cell.innerHTML = '';
                cell.className = 'cell';
                
                if (selectedCell && selectedCell.r === r && selectedCell.c === c) {
                    cell.classList.add('selected');
                }

                if (phase === 'MOVE' && selectedCell && !data && isValidQueenMove(selectedCell.r, selectedCell.c, r, c)) {
                    cell.classList.add('valid-move');
                }

                if (data) {
                    const stone = document.createElement('div');
                    stone.className = `stone stone-${data.owner}`;
                    stone.innerText = data.val;
                    
                    if (phase === 'REMOVAL_BONUS' && data.owner === currentPlayer && 
                        (r !== movedStoneCoords.r || c !== movedStoneCoords.c)) {
                        stone.classList.add('removable-highlight');
                    }
                    
                    cell.appendChild(stone);
                }
            });

            turnNameEl.innerText = currentPlayer;
            turnPillEl.style.backgroundColor = currentPlayer === 'black' ? '#111827' : '#f9fafb';
            
            phaseEl.innerText = phase === 'REMOVAL_BONUS' ? 'Selective Removal' : 
                               (phase === 'MOVE' ? 'Optional Move' : 'Compulsory Placement');
            
            skipBtn.style.display = phase === 'MOVE' ? 'block' : 'none';
            placementUI.style.display = phase === 'PLACE' ? 'block' : 'none';
            
            if (phase === 'REMOVAL_BONUS') {
                removalBonusUI.classList.remove('hidden');
                removalCountEl.innerText = removalsToResolve;
                document.getElementById('phase-container').classList.replace('bg-indigo-50', 'bg-emerald-50');
            } else {
                removalBonusUI.classList.add('hidden');
                document.getElementById('phase-container').classList.replace('bg-emerald-50', 'bg-indigo-50');
            }

            document.getElementById('black-score').innerText = calculateScore('black');
            document.getElementById('white-score').innerText = calculateScore('white');
            
            document.getElementById('black-used').innerText = Array.from(activeValues.black).sort((a,b)=>a-b).join(', ');
            document.getElementById('white-used').innerText = Array.from(activeValues.white).sort((a,b)=>a-b).join(', ');
        }

        skipBtn.addEventListener('click', () => {
            if (phase === 'MOVE') {
                selectedCell = null;
                enterPlacementPhase();
                updateUI();
            }
        });

        init();
    </script>
</body>
</html>
